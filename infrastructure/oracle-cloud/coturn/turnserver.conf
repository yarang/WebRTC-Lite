# Coturn TURN Server Configuration for WebRTC-Lite
# Optimized for Oracle Cloud Free Tier (Ubuntu 22.04)
#
# This configuration implements:
# - STUN/TURN services with TLS/DTLS 1.3
# - Dynamic authentication with time-limited credentials
# - Oracle Cloud Free Tier network constraints
#
# Requirements: REQ-U001, REQ-U003, REQ-S001, REQ-S003

# ============================================================================
# NETWORK CONFIGURATION
# ============================================================================

# listening-port: Default STUN/TURN listening port
listening-port=3478

# tls-listening-port: TLS listening port for TURN over TLS
tls-listening-port=5349

# listening-ip: Local IP address to listen on (all interfaces)
listening-ip=0.0.0.0

# relay-ip: Local IP used for relay (use private IP for OCI)
relay-ip=10.0.0.2

# external-ip: Public IP address of your Oracle Cloud instance
# Replace with your actual OCI public IP
external-ip=YOUR_PUBLIC_IP

# alt-listening-port: Alternative port for when primary is blocked
alt-listening-port=3479

# alt-tls-listening-port: Alternative TLS port
alt-tls-listening-port=5350

# ============================================================================
# AUTHENTICATION
# ============================================================================

# lt-cred-mech: Use long-term credential mechanism
# HMAC-SHA1 based authentication with time-based usernames
lt-cred-mech

# userdb: Path to user database for static credentials (optional)
userdb=/var/lib/turn/turndb

# realm: Authentication realm
realm=webrtc-lite.example.com

# stale-nonce: Enhances security by using stale nonce
stale-noce

# ============================================================================
# SECURITY & ENCRYPTION
# ============================================================================

# fingerprint: Use DTLS fingerprint for WebRTC compatibility
fingerprint

# no-loopback-peers: Deny packets from loopback addresses
no-loopback-peers

# no-multicast-peers: Deny packets from multicast addresses
no-multicast-peers

# Keep-alive mechanism for NAT traversal
keep-address-family

# Disable loopback addresses in relay
no-udp-loop

# Maximize security with modern cipher suites (TLS 1.3)
cipher-list="ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384"

# DH file size (bits)
dh-file-size=2048

# ============================================================================
# TLS CERTIFICATES
# ============================================================================

# Certificate paths for Let's Encrypt
# Update these paths after running certbot
cert=/etc/letsencrypt/live/turn.example.com/fullchain.pem
pkey=/etc/letsencrypt/live/turn.example.com/privkey.pem

# CA certificate for certificate verification
# ca-file=/etc/letsencrypt/live/turn.example.com/chain.pem

# Enable TLS 1.3 only (most secure)
# For compatibility, we support TLS 1.2 and 1.3
# tls12
# tls13

# ============================================================================
# ORACLE CLOUD OPTIMIZATION
# ============================================================================

# Oracle Cloud Free Tier bandwidth limits
# Max bitrate per session (Kbps)
max-bps=3000000

# Total bitrate limit for all sessions (Kbps)
# Free Tier: 10TB/month = ~30Mbps sustained
total-quota=300000

# CPU load reduction for Free Tier VM
# Reduce threads to prevent CPU overuse
min-port=49152
max-port=65535

# Maximum relay sessions (Free Tier constraint)
max-allocate-lifetime=3600
max-bps-capacity=0

# ============================================================================
# LOGGING & MONITORING
# ============================================================================

# Log file location
log-file=/var/log/turnserver.log

# Verbose logging for debugging
verbose

# Enable WebRTC statistics
# Turn on for debugging connection issues
# webRTC-stats

# Enable STUN only functionality (no relay) for direct P2P
# This saves bandwidth when P2P succeeds
stun-only

# But also enable TURN relay when STUN fails
# TURN relay is required for NAT traversal (REQ-S001)

# ============================================================================
# PERFORMANCE TUNING
# ============================================================================

# IO threads (optimize for OCI Free Tier: 1 OCPU)
# Reduce to prevent CPU exhaustion
io-thread-count=2

# Relay threads
relay-thread-count=2

# Block external access to management ports
no-cli

# Connection tracking
no-sslv2
no-sslv3

# Mobility with ICE (MOBIKE)
mobility

# DSCP marking for QoS
# dscp=46  # Expedited Forwarding for real-time traffic

# ============================================================================
# RATE LIMITING & DDOS PROTECTION
# ============================================================================

# Deny requests from suspicious IPs
# sec-client-ip banned-ip-list

# Maximum allocations per user (prevent abuse)
max-allocate-per-user=10

# Maximum permissions per allocation
max-permission-per-user=10

# User quota
user-quota=100

# Total quota
total-quota=1000

# ============================================================================
# FINGERPRINT & CHANNEL DATA
# ============================================================================

# Require fingerprint for WebRTC
# This ensures only WebRTC clients can connect

# Channel data timeout (seconds)
channel-lifetime=600

# Permission lifetime
permission-lifetime=300

# ============================================================================
# ADVANCED OPTIONS
# ============================================================================

# Allow private IP ranges (for OCI internal communication)
# WARNING: Review security implications
allowed-peer-ip=10.0.0.0-10.0.0.255

# Enable prometheus metrics for monitoring
# prometheus-agent-ip=127.0.0.1
# prometheus-agent-port=9641

# Redis support for distributed TURN (future enhancement)
# redis-statsdb="ip=127.0.0.1:6379"

# ============================================================================
# END OF CONFIGURATION
# ============================================================================
