###############################################################################
# Fail2Ban Jail Configuration for WebRTC-Lite TURN Server
#
# This configuration protects against brute force attacks on SSH and TURN services.
#
# Requirements: REQ-N002, REQ-S003
#
# Place in: /etc/fail2ban/jail.d/webrtc-lite.conf
###############################################################################

[DEFAULT]
# Ban time: 1 hour
bantime = 3600

# Find time: 10 minutes
findtime = 600

# Max retries: 5
maxretry = 5

# Destination email for alerts
destemail = root@localhost
sender = fail2ban@localhost

# Action
action = %(action_)s

##############################################################################
# SSH JAIL
##############################################################################

[sshd]
enabled = true
port = 22
logpath = /var/log/auth.log
maxretry = 3
bantime = 7200

##############################################################################
# COTURN JAIL (Custom filter)
##############################################################################

[coturn]
enabled = true
port = 3478,5349
protocol = udp
logpath = /var/log/turnserver.log
maxretry = 20
findtime = 300
bantime = 1800

# Filter pattern for TURN authentication failures
failregex = ^.*\(username:.*\): nonce.*failed$
            ^.*401.*unauthorized$
            ^.*authentication failed.*$

ignoreregex =

##############################################################################
# NGINX JAIL (TURN API)
##############################################################################

[nginx-req-limit]
enabled = true
port = http,https
logpath = /var/log/nginx/error.log
maxretry = 10
findtime = 60
bantime = 600

##############################################################################
# DDOS PROTECTION
##############################################################################

[nginx-http-auth]
enabled = true
port = http,https
logpath = /var/log/nginx/error.log

[nginx-noscript]
enabled = true
port = http,https
logpath = /var/log/nginx/access.log
maxretry = 6
bantime = 600

[nginx-badbots]
enabled = true
port = http,https
logpath = /var/log/nginx/access.log
maxretry = 2
bantime = 86400

[nginx-noproxy]
enabled = true
port = http,https
logpath = /var/log/nginx/access.log
maxretry = 2
bantime = 86400

##############################################################################
# ACTIONS
##############################################################################

[Action-iptables]
# Check for custom iptables chain
actionstart = iptables -N f2b-<name>
              iptables -A f2b-<name> -j RETURN
              iptables -I <chain> -p <protocol> --dport <port> -j f2b-<name>

actionstop = iptables -D <chain> -p <protocol> --dport <port> -j f2b-<name>
             iptables -F f2b-<name>
             iptables -X f2b-<name>

actioncheck = iptables -n -L <chain> | grep -q 'f2b-<name>[ \t]'

actionban = iptables -I f2b-<name> 1 -s <ip> -j <blocktype>

actionunban = iptables -D f2b-<name> -s <ip> -j <blocktype>
